<script>
// ==UserScript==
// @name        Pokevision Enhancer
// @namespace   https://greasyfork.org/en/users/814-bunta
// @description Save/Load filter list, scan an area for pokemon, plus more!
// @include     *pokevision.com/*
// @version     1.2
// @Author      Bunta
// @license     http://creativecommons.org/licenses/by-nc-sa/3.0/us/
// @grant       none
// ==/UserScript==


var scanDelay = 1000; // time between scans for each lat/long position. Should be no lower than 1000 (1s)
var autoDelay = 60000; // time between scans repeating when Auto checkbox is enabled
var scanOnLoad = false; // if true will perform scan as soon as page is loaded or refreshed
var minLat = 43.67, maxLat = 43.65, minLon = -79.44, maxLon = -73.37; // bounds for the scan area. minLat is northmost value, minLon is westmost value. Scans adjust lat/long by 0.01

/* run below code (after setting above position variables) in console to view the bounds of your search area
App.home.createMarker(1,{latitude: minLat,longitude:minLon,pokemonId:151,}); // Mew should be top left
App.home.createMarker(1,{latitude: minLat,longitude:maxLon,pokemonId:25,});  // Pikachu should be top right
App.home.createMarker(1,{latitude: maxLat,longitude:minLon,pokemonId:26,});  // Raichu should be bottom left
App.home.createMarker(1,{latitude: maxLat,longitude:maxLon,pokemonId:150,}); // MewTwo should be bottom right
*/

var  pokemonAlertList = { //Choose which pokemon you want to be alerted about!
  "Bulbasaur":true,
  "Ivysaur":true,
  "Venusaur":true,
  "Charmander":true,
  "Charmeleon":true,
  "Charizard":true,
  "Squirtle":true,
  "Wartortle":true,
  "Blastoise":true, 
  "Caterpie":false, 
  "Metapod":true,
  "Butterfree":true,
  "Weedle":false,
  "Kakuna":true,
  "Beedrill":true,
  "Pidgey":false,
  "Pidgeotto":true,
  "Pidgeot":true,
  "Rattata":false,
  "Raticate":true,
  "Spearow":false,
  "Fearow":true,
  "Ekans":true,
  "Arbok":true,
  "Pikachu":true,
  "Raichu":true,
  "Sandshrew":true,
  "Sandslash":true,
  "Nidoran♀":true,
  "Nidorina":true,
  "Nidoqueen":true,
  "Nidoran♂":true,
  "Nidorino":true,
  "Nidoking":true,
  "Clefairy":true,
  "Clefable":true,
  "Vulpix":true,
  "Ninetales":true,
  "Jigglypuff":true,
  "Wigglytuff":true,
  "Zubat":false,
  "Golbat":true,
  "Oddish":true,
  "Gloom":true,
  "Vileplume":true,
  "Paras":true,
  "Parasect":true,
  "Venonat":true,
  "Venomoth":true,
  "Diglett":true,
  "Dugtrio":true,
  "Meowth":true,
  "Persian":true,
  "Psyduck":true,
  "Golduck":true,
  "Mankey":true,
  "Primeape":true,
  "Growlithe":true,
  "Arcanine":true,
  "Poliwag":true,
  "Poliwhirl":true,
  "Poliwrath":true,
  "Abra":true,
  "Kadabra":true,
  "Alakazam":true,
  "Machop":true,
  "Machoke":true,
  "Machamp":true,
  "Bellsprout":true,
  "Weepinbell":true,
  "Victreebel":true,
  "Tentacool":true,
  "Tentacruel":true,
  "Geodude":true,
  "Graveler":true,
  "Golem":true,
  "Ponyta":true,
  "Rapidash":true,
  "Slowpoke":true,
  "Slowbro":true,
  "Magnemite":true,
  "Magneton":true,
  "Farfetch'd":true,
  "Doduo":true,
  "Dodrio":true,
  "Seel":true,
  "Dewgong":true,
  "Grimer":true,
  "Muk":true,
  "Shellder":false,
  "Cloyster":true,
  "Gastly":false,
  "Haunter":true,
  "Gengar":true,
  "Onix":true,
  "Drowzee":false,
  "Hypno":true,
  "Krabby":false,
  "Kingler":true,
  "Voltorb":true,
  "Electrode":true,
  "Exeggcute":true,
  "Exeggutor":true,
  "Cubone":true,
  "Marowak":true,
  "Hitmonlee":true,
  "Hitmonchan":true,
  "Lickitung":true,
  "Koffing":true,
  "Weezing":true,
  "Rhyhorn":true,
  "Rhydon":true,
  "Chansey":true,
  "Tangela":true,
  "Kangaskhan":true,
  "Horsea":true,
  "Seadra":true,
  "Goldeen":true,
  "Seaking":true,
  "Staryu":true,
  "Starmie":true,
  "Mr. Mime":true,
  "Scyther":true,
  "Jynx":false,
  "Electabuzz":true,
  "Magmar":true,
  "Pinsir":true,
  "Tauros":true,
  "Magikarp":true,
  "Gyarados":true,
  "Lapras":true,
  "Ditto":true,
  "Eevee":true,
  "Vaporeon":true,
  "Jolteon":true,
  "Flareon":true,
  "Porygon":true,
  "Omanyte":true,
  "Omastar":true,
  "Kabuto":true,
  "Kabutops":true,
  "Aerodactyl":true,
  "Snorlax":true,
  "Articuno":true,
  "Zapdos":true,
  "Moltres":true,
  "Dratini":true,
  "Dragonair":true,
  "Dragonite":true,
  "Mewtwo":true, 
  "Mew":true,
}

// Test if local storage is available
function storageAvailable(type) {
  try {
    var storage = window[type],
      x = '__storage_test__';
    storage.setItem(x, x);
    storage.removeItem(x);
    return true;
  }
  catch(e) {
    return false;
  }
}
var storageAllowed = storageAvailable('localStorage');

// Start with some style fixes to improve map visibility
function addGlobalStyle(css) {
    var head, style;
    head = document.getElementsByTagName('head')[0];
    if (!head) { return; }
    style = document.createElement('style');
    style.type = 'text/css';
    style.innerHTML = css;
    head.appendChild(style);
}
addGlobalStyle("header { padding: 5px 0 ! important }")
addGlobalStyle("body.home { padding: 40px 0px 0px 0 ! important }")
$("footer").remove()

// Function to update the pokemon list to the selected pokemon above
function refreshFilter() {
  $("button.bs-deselect-all").click()
  for (key in pokemonAlertList) {
    if (pokemonAlertList[key]) {
      $("ul.dropdown-menu.inner li span").filter(function(index) { return $(this).text() === key; }).click();
    }
  }
}

// Function to save the pokemon list to local storage
function saveFilter() {
  var selectedPokemon = [];
  $('.dropdown-menu.inner li.selected').each(function(_, el){
    selectedPokemon.push($(el).data('original-index'));
  });
  localStorage.setItem('selectedPokemon', JSON.stringify(selectedPokemon));
}

// Function to load the pokemon list from local storage
function loadFilter() {
  var selectedPokemon
  try {
    selectedPokemon = JSON.parse(localStorage.selectedPokemon);
  } catch(e) {
    refreshFilter();
    return;
  }
  
  if (selectedPokemon == null || selectedPokemon == "") { refreshFilter(); return; }
  
  $("button.bs-deselect-all").click()
  selectedPokemon.forEach(function(pokemonId) {
    $("ul.dropdown-menu.inner li[data-original-index=" + pokemonId + "] a").click();
  });
}

var scanning = false;

// function to perform scanning in grid area bound by lat/long variables set above
function scanLoop(lat,lon) {
  if (lon > maxLon) {
    lat -= 0.01;
    lon = minLon;
  }
  
  if (lat < maxLat) {
    console.log("Scanning Complete:", (new Date()).toLocaleTimeString());
    if ($("#autoRescan").prop("checked"))
    {
      console.log("Next scan will start:", (new Date((new Date()).getTime() + autoDelay)).toLocaleTimeString());
      setTimeout(function() {
        console.log("Initiating Scan:", (new Date()).toLocaleTimeString());
        scanLoop(minLat,minLon);
      }, autoDelay);
    } else {
      scanning = false;
    }
    return;
  }
  
  //console.log("scanning:",lat,lon);
  App.home.findNearbyPokemon(lat, lon);
  setTimeout(function() { scanLoop(lat,lon+0.01); }, scanDelay);
}

// Add buttons to header bar
if (storageAllowed) {
  $("a.header-map-locate").before('<input type="checkbox" name="autoRescan" id="autoRescan" value="Auto">Auto  <button id="rescanPokes">Scan</Rescan><button id="saveFilter">Save Filter</button><button id="loadFilter">Load Filter</button>');
} else {
  $("a.header-map-locate").before('<input type="checkbox" name="autoRescan" id="autoRescan" value="Auto">Auto  <button id="rescanPokes">Scan</Rescan><button id="refreshFilter">Filter</button>');
}

// Add click functions to buttons
$("#rescanPokes").click(function() {
  console.log("rescanPokes");
  if (!scanning) {
    scanning = true;
    console.log("Initiating Scan:", (new Date()).toLocaleTimeString());
    scanLoop(minLat,minLon);
  }
});
$("#refreshFilter").click(function() {
  console.log("refreshFilter");
  refreshFilter();
});
$("#saveFilter").click(function() {
  console.log("saveFilter");
  saveFilter();
});

$("#loadFilter").click(function() {
  console.log("loadFilter");
  loadFilter();
});


// Update filter and scan on page load (if enabled)
$(window).load(function(){
  if (storageAllowed) {
    loadFilter();
  } else {
    refreshFilter();
  }
  
  if (!scanning && scanOnLoad) {
    scanning = true;
    console.log("Initiating Scan:", (new Date()).toLocaleTimeString());
    scanLoop(minLat,minLon);
  }
});
</script>